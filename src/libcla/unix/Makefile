CFLAGS+= -g -ggdb -O0 -Wall -pedantic -std=c99 -I..
CFLAGS_TP+=$(CFLAGS)
CFLAGS_TP+= -DCLA_STATIC_SUPPORT -DCLA_TEST_PROG

all:	unix

unix:			\
	cla_dispatch
#\
#	libcla.0.so	\
#	examples

libcla.0.so: ../cla.c Makefile
	${CC} ${CFLAGS} -o libcla.0.so -shared -fpic ../cla.c

cla_dispatch: regen ../cla.c ../cla.h Makefile 
	${CC} ${CFLAGS_TP} -o cla_dispatch ../cla.c

examples:
	(cd samples && make clean && make)

regen:
	@printf '\t/* autogenerated from Makefile! */\n' > _.t
	@grep '^TEST_DECL' ../cla.c | cut -d "(" -f 2 | cut -d "," -f 1 |	\
	while read T; do						\
		printf "\tTEST_UNIT(%s)\n" $${T} >> _.t;		\
	done;
	@mv _.t ../cla_tests.h
	@echo "# cla_tests.h regenerated"

clean:
	rm -rf cla_dispatch
	rm -rf libcla.0.so
	(cd samples && make clean)
