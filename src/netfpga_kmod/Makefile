#V=1.1
#V=fa2.0
#V=fb2.0
V=1.2.5

NFPROG=netfpga_program.sh
ROOT=/home/wkoszek/nf
BFS=$(ROOT)/$(V)/NF2/bitfiles/

CPCI_REPROG=$(BFS)/cpci_reprogrammer.bit
CPCI=$(BFS)/CPCI_2.1.bit
REF=$(BFS)/reference_nic.bit

KMOD=	netfpga
SRCS+=	netfpga.c netfpga_subr.c netfpga.h device_if.h bus_if.h pci_if.h miibus_if.h netfpga_fw.h

netfpga_fw.h: ../../include/reg_defines.h ../../include/nf2_common.h ../../include/nf2.h
	@echo "/* This file is autogenerated from various .h files. Don't edit! */" > ${.TARGET}
	@echo "#ifndef _NETFPGA_FW_H_" >> ${.TARGET}
	@echo "#define _NETFPGA_FW_H_" >> ${.TARGET}
	@cat $> | gzip -c | file2c -s 'char netfpga_fw[] = {' '};' >> ${.TARGET}
	@echo "#endif  /* _NETFPGA_FW_H_ */" >> ${.TARGET}

up:
	(cd ../../ && make up)

p:
	-kldunload netfpga
	kldload ./netfpga.ko

	(cd ../netfpga && ./$(NFPROG) $(CPCI_REPROG) $(CPCI) $(REF))

	./setif.sh

mrproper:
	make clean
	(cd ../netfpga && make clean)

rb:
	make
	(cd ../netfpga && make && make libs)

CLEANFILES+=	netfpga_fw.h

.include <bsd.kmod.mk>
